# cache ÌôúÏö©
name: deploy service

on:
  push: # ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïã§Ìñâ Ï°∞Í±¥ Ïù¥Î≤§Ìä∏
    branches: # ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïã§Ìñâ Ï°∞Í±¥ Î∏åÎûúÏπò
      - main

jobs:
  ssh-agent: # Job Ïù¥Î¶Ñ
    runs-on: ubuntu-24.04 # GitHub ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Ïó∞Í≤∞

    steps: # Ïã§ÌñâÌï† ÏûëÏóÖ(step)
      # ÏÜåÏä§ ÏΩîÎìúÎ•º ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§Î°ú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout code
        uses: actions/checkout@v4

      # ÎîîÏä§ÏΩîÎìú ÏõπÌõÖ ÏïåÎ¶º Î©îÏÑ∏ÏßÄ
      - name: Discord Notification - Start
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "üíô Î∞∞Ìè¨ ÏãúÏûë üíô"
          description: |
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.event.head_commit.message }}
          color: 0x0000ff

      # Ï∫êÏãú Ï†ÄÏû• ÏÑ§Ï†ïÏùÑ ÏúÑÌïú action(ÎùºÏù¥Î∏åÎü¨Î¶¨)
      - name: Cache Docker Image Layer
        # actions/cache: ÍπÉÌóàÎ∏å Ï∫êÏãú Ï†ÄÏû•ÏÜå ÌôúÏö©ÏùÑ ÏúÑÌïú ÎùºÏù¥Î∏åÎü¨Î¶¨
        uses: actions/cache@v4.2.0
        with:
          path: /tmp/.buildx-cache # Ï∫êÏãúÎ°ú Í¥ÄÎ¶¨Ìï† Í≤ΩÎ°ú
          key: docker-image-layer-cache-${{ github.sha }} # Î∂àÎü¨Ïò¨ Ï∫êÏãú Ïù¥Î¶Ñ(ÏãùÎ≥ÑÏûê)
          restore-keys: docker-image-layer-cache # ÎßåÏïΩ Ï∫êÏãú keyÎ•º Ï∞æÏßÄ Î™ªÌïòÎ©¥ ÎåÄÏ≤¥Ìï† Ï∫êÏãú key Ìå®ÌÑ¥

      # ÌôòÍ≤Ω Î≥ÄÏàò ÌååÏùº ÏÉùÏÑ±
      - name: Create .env file
        run: |
          echo "DATABASE_HOST=${{ secrets.DATABASE_HOST }}" >> .env
          echo "DATABASE_NAME=${{ secrets.DATABASE_NAME }}" >> .env
          echo "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" >> .env
          echo "DATABASE_PORT=${{ secrets.DATABASE_PORT }}" >> .env
          echo "DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}" >> .env
          echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}" >> .env
          echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> .env
          echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> .env
          echo "DISCORD_WEBHOOK"=${{ secrets.DISCORD_WEBHOOK }}" >> .env

      # ÎèÑÏª§ BuildKit ÏóîÏßÑ ÏÑ§Ï†ï action(ÎùºÏù¥Î∏åÎü¨Î¶¨)
      - name: Set up Docker Buildkit
        # setup-buildx-actions
        # - BuildKitÏùÑ ÏÑ§ÏπòÌïòÎäî actions(ÎùºÏù¥Î∏åÎü¨Î¶¨)
        # buildx = BuildKit
        uses: docker/setup-buildx-action@v3

      # BuildKit ÏóîÏßÑ ÎπåÎçî(Ïù¥ÎØ∏ÏßÄ ÎπåÎìúÎ•º ÎèÑÏôÄÏ£ºÎäî ÎèÑÍµ¨) ÏÉùÏÑ±
      # Í∏∞Ï°¥ Docker ÎπåÎçî : Cache ÌååÏùº Ï†ÄÏû•&Î∂àÎü¨Ïò§Í∏∞ Í≤ΩÎ°ú Ï†úÏñ¥ Î∂àÍ∞Ä
      - name: Create BuildKit ÎπåÎçî
        # 1. buildkit ÎπåÎçî(buildkit)Î•º ÏÉùÏÑ±ÌïòÎäî Î™ÖÎ†πÏñ¥
        # 2. ÎπåÎçî(buildkit) ÏÑ§Ï†ï Î™ÖÎ†πÏñ¥
        run: docker buildx create --use --name buildkit-builder

      # ÏõêÍ≤© ÏÑúÎ≤ÑÎ•º Ïã†Î¢∞Ìï† Ïàò ÏûàÎäî ÏÑúÎ≤ÑÎ°ú Îì±Î°ùÌïòÎäî Í≥ºÏ†ï
      # known_hosts : ÏõêÍ≤© ÏÑúÎ≤ÑÎì§Ïùò ÏßÄÎ¨∏Ïù¥ Ï†ÄÏû•Îêú ÌååÏùº
      - name: Add Remote Server Fingerprint to Known Hosts
        run: ssh-keyscan -H -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts || true

      - name: Login DockerHub
        run: echo '${{ secrets.DOCKER_PASSWORD}}' | docker login -u '${{ secrets.DOCKER_USERNAME }}' --password-stdin

      - name: Docker Image Build
        run: docker compose -f docker-compose-actions-cache.yml build --build-arg BUILDKIT_INLINE_CACHE=1

      - name: Docker Image Push
        run: docker compose -f docker-compose-actions-cache.yml push

      - name: Copy .env / docker-compose-actions-cache.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "docker-compose-actions-cache.yml,.env"
          target: "~/github-actions-work-directory"

      - name: Pull Image & Up Container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ~/github-actions-work-directory
            docker compose -f docker-compose-actions-cache.yml pull
            docker compose -f docker-compose-actions-cache.yml down
            docker compose -f docker-compose-actions-cache.yml up -d
            docker system prune -f

      # Discord ÏïåÎ¶º - Î∞∞Ìè¨ ÏÑ±Í≥µ
      - name: Discord Notification - Success
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "‚úÖ Î∞∞Ìè¨ ÏÑ±Í≥µ!"
          description: |
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.event.head_commit.message }}
          color: 0x00ff00

      # Discord ÏïåÎ¶º - Î∞∞Ìè¨ Ïã§Ìå®
      - name: Discord Notification - Failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "‚ùå Î∞∞Ìè¨ Ïã§Ïàò "
          description: |
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.event.head_commit.message }}
          color: 0xff0000
